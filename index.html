<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora de Horas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SDK Supabase (inclua apenas uma vez) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (function initSupabase(){
      const sdkOk = !!window.supabase && typeof window.supabase.createClient === "function";
      if (!sdkOk) { console.error("Supabase SDK n√£o carregado."); return; }
      if (!window.__sb) {
        window.__sb = window.supabase.createClient(
          "https://pldamguukjeuakrvfbzf.supabase.co",
          "sb_publishable_UybNTjqz8fdbDLFhxJvO5Q_78P0AM6Y"
        );
      }
    })();
    const db = window.__sb;
  </script>

  <style>
    :root {
      --bg:#0b0b0b; --panel:#121212; --border:#1e1e1e;
      --text:#e9e9e9; --muted:#9a9a9a;
      --green:#2ecc71; --blue:#3b82f6; --orange:#f59e0b; --red:#ef4444; --gold:#ffd700;
    }
    * { box-sizing:border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font-family:Arial,sans-serif; }
    h1,h3 { margin:0 0 12px; }

    .layout { display:flex; flex-direction:column; height:100vh; }
    .topbar { padding:16px; background:var(--panel); border-bottom:1px solid var(--border); }
    .content { display:flex; flex:1; min-height:0; overflow:hidden; }

    /* Sidebar mais larga e com rolamento interno */
    .sidebar {
      flex:0 0 500px; width:500px; max-width:100%;
      padding:16px; background:var(--panel); border-right:1px solid var(--border);
      overflow-y:auto; overflow-x:hidden;
    }
    .main { flex:1; min-width:0; padding:20px; }

    .card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:18px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .col { flex:1; min-width:160px; }

    input,select { width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0e0e0e; color:var(--text); }
    input::placeholder { color:#7a7a7a; }

    .btn { padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:#151515; color:var(--text); cursor:pointer; }
    .btn.primary { background:var(--green); border-color:var(--green); color:#0b0b0b; }
    .btn.blue { background:var(--blue); border-color:var(--blue); color:#0b0b0b; }
    .btn.red { background:var(--red); border-color:var(--red); color:#0b0b0b; }

    /* Chips em duas linhas: nome em cima, ID embaixo */
    .chip {
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      padding:10px 14px; border-radius:12px; background:#151515; border:1px solid var(--border); margin:6px 0; font-size:13px;
    }
    .chip.clickable { cursor:pointer; }
    .chip.selected { background:var(--green); color:#0b0b0b; border-color:var(--green); }

    .chip .left { display:flex; flex-direction:column; align-items:flex-start; gap:2px; min-width:0; }
    .chip .label { font-weight:600; font-size:14px; white-space:normal; word-break:break-word; }
    .chip .sub { font-size:12px; color:var(--muted); white-space:normal; word-break:break-word; }
    .chip .right { display:flex; align-items:center; gap:4px; flex-wrap:wrap; }

    .badge { display:inline-block; padding:4px 10px; border-radius:999px; background:#1a1a1a; border:1px solid var(--border); font-size:12px; }
    .badge.Dono { background:var(--gold); color:#0b0b0b; font-weight:700; }
    .badge.Gerente { background:var(--blue); color:#0b0b0b; font-weight:700; }

    /* Bot√µes menores nos chips */
    .mini-btn { padding:3px 6px; font-size:11px; border-radius:8px; border:1px solid var(--border); background:#1a1a1a; color:var(--text); cursor:pointer; }
    .mini-btn.orange { background:var(--orange); color:#0b0b0b; border-color:var(--orange); }
    .mini-btn.red { background:var(--red); color:#0b0b0b; border-color:var(--red); }

    table { width:100%; border-collapse:collapse; border-radius:12px; table-layout:fixed; }
    th,td { padding:10px 12px; border-bottom:1px solid var(--border); text-align:left; font-size:14px; word-wrap:break-word; }
    thead th { background:#141414; color:var(--muted); }

    .reg-list { display:flex; flex-direction:column; gap:8px; }
    .reg-item { display:flex; align-items:center; justify-content:space-between; background:#151515; border:1px solid var(--border); border-radius:10px; padding:8px 10px; }
    .reg-item .time { font-weight:600; }
    .reg-item .remove { color:var(--red); cursor:pointer; font-weight:700; }

    /* Card de registros com altura limitada e rolagem interna */
    .card.registros {
      display:flex; flex-direction:column;
      max-height: 340px;            /* limite visual do card */
      overflow:hidden;              /* impede o card de estourar */
    }
    .card.registros h3 { margin-bottom:10px; }
    #registrosArea {
      flex:1 1 auto;                /* ocupa o espa√ßo dispon√≠vel do card */
      overflow-y: auto;             /* rola verticalmente dentro da √°rea */
      min-height: 140px;            /* garante √°rea √∫til m√≠nima */
      padding-right: 6px;           /* espa√ßo para a barra */
    }

    .rank { background:#1a1a1a; border:1px solid var(--border); border-radius:10px; padding:10px; margin-top:10px; }
    .rank-item { display:flex; justify-content:space-between; padding:6px 8px; border-radius:8px; background:#151515; border:1px solid var(--border); margin:6px 0; }
    .rank-pos { font-weight:700; }

    .error { color:var(--red); font-size:13px; margin-top:8px; }
    .muted { color:var(--muted); font-size:13px; }

    @media (max-width: 980px) {
      .content { flex-direction:column; }
      .sidebar {
        width:100%;
        flex:0 0 auto;
        border-right:none;
        border-bottom:1px solid var(--border);
        max-height:45vh;
      }
      .main { flex:1 1 auto; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Topo: Donos e Gerentes -->
    <div class="topbar">
      <h3>Donos e Gerentes</h3>
      <div id="listaResponsaveis"></div>
      <div class="row" style="margin-top:12px;">
        <div class="col"><input id="novoResponsavelNome" type="text" placeholder="Nome do respons√°vel"></div>
        <div class="col"><input id="novoResponsavelId" type="text" placeholder="ID (opcional, vincular ao funcion√°rio)"></div>
        <div class="col">
          <select id="novoResponsavelCargo">
            <option value="Dono">Dono</option>
            <option value="Gerente">Gerente</option>
          </select>
        </div>
        <div class="col" style="flex:0 0 auto;">
          <button class="btn primary" id="btnAddResponsavel">Adicionar respons√°vel</button>
        </div>
      </div>
    </div>

    <div class="content">
      <!-- Sidebar: Funcion√°rios -->
      <div class="sidebar">
        <h3>Funcion√°rios (<span id="contadorFuncionarios">0</span>)</h3>
        <div id="listaFuncionarios"></div>
        <div class="row" style="margin-top:12px;">
          <div class="col"><input id="novoNome" type="text" placeholder="Nome"></div>
          <div class="col"><input id="novoId" type="text" placeholder="ID"></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="col" style="flex:0 0 auto;"><button class="btn primary" id="btnAddFuncionario">Adicionar</button></div>
          <div class="col" style="flex:0 0 auto;"><button class="btn red" id="btnLimparTodos">Limpar TODOS</button></div>
        </div>
        <p class="muted" style="margin-top:8px;">‚ÄúEditar‚Äù altera nome/ID e migra registros. ‚ÄúLimpar‚Äù apaga registros do funcion√°rio.</p>
      </div>

      <!-- Main -->
      <div class="main">
        <h1>Calculadora de Horas</h1>

        <div class="card">
          <h3>Adicionar Horas</h3>
          <div class="row">
            <div class="col"><input id="horas" type="number" min="0" placeholder="Horas"></div>
            <div class="col"><input id="minutos" type="number" min="0" max="59" placeholder="Minutos"></div>
            <div class="col"><input id="segundos" type="number" min="0" max="59" placeholder="Segundos"></div>
            <div style="align-self:end;"><button class="btn primary" id="btnAddRegistro">Registrar</button></div>
            <div style="align-self:end;"><button class="btn blue" id="btnOrdenar">Ordenar por total</button></div>
          </div>
          <div id="msgErro" class="error" style="display:none;"></div>
        </div>

        <div class="card">
          <h3>Resultados</h3>
          <table>
            <thead><tr><th>Nome</th><th>ID</th><th>Total (h:m:s)</th><th>Total (segundos)</th></tr></thead>
            <tbody id="tabelaBody"></tbody>
          </table>
          <div class="rank">
            <h3>üèÜ Ranking Top 3</h3>
            <div id="rankList"></div>
          </div>
        </div>

        <div class="card registros">
          <h3>Registros do Funcion√°rio Selecionado</h3>
          <div id="registrosArea" class="reg-list"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    if (!db || typeof db.from !== "function") {
      console.error("Cliente Supabase n√£o inicializado corretamente.");
    }

    // Estado
    let funcionarios = [];
    let pessoas = {};
    let funcionarioSelecionado = null;
    let responsaveis = [];

    // Utils
    const chavePessoa = (nome,id)=>`${nome}::${id}`;
    const toSeconds=(h,m,s)=>(h*3600)+(m*60)+s;
    const fmtHMS=total=>`${Math.floor(total/3600)}h ${Math.floor((total%3600)/60)}m ${total%60}s`;

    // DOM refs
    const listaFuncionariosEl=document.getElementById("listaFuncionarios");
    const contadorFuncionariosEl=document.getElementById("contadorFuncionarios");
    const tabelaBodyEl=document.getElementById("tabelaBody");
    const registrosArea=document.getElementById("registrosArea");
    const rankList=document.getElementById("rankList");
    const novoNomeEl=document.getElementById("novoNome");
    const novoIdEl=document.getElementById("novoId");
    const horasEl=document.getElementById("horas");
    const minutosEl=document.getElementById("minutos");
    const segundosEl=document.getElementById("segundos");
    const msgErroEl=document.getElementById("msgErro");

    const listaResponsaveisEl=document.getElementById("listaResponsaveis");
    const novoResponsavelNomeEl=document.getElementById("novoResponsavelNome");
    const novoResponsavelIdEl=document.getElementById("novoResponsavelId");
    const novoResponsavelCargoEl=document.getElementById("novoResponsavelCargo");

    function showError(msg){
      msgErroEl.textContent=msg;
      msgErroEl.style.display="block";
      setTimeout(()=>{msgErroEl.style.display="none";},3500);
    }

    // ---------- Funcion√°rios ----------
    function renderFuncionarios(){
      listaFuncionariosEl.innerHTML="";
      contadorFuncionariosEl.textContent = funcionarios.length;

      if(funcionarios.length===0){
        listaFuncionariosEl.innerHTML="<p class='muted'>Nenhum funcion√°rio cadastrado.</p>";
        return;
      }
      funcionarios.forEach((f,idx)=>{
        const chip=document.createElement("div");
        chip.className="chip clickable"+(funcionarioSelecionado===idx?" selected":"");
        chip.title=`${f.nome} ‚Äî ID: ${f.id}`;
        chip.addEventListener("click",()=>selecionarFuncionario(idx));

        const left=document.createElement("div"); left.className="left";
        const label=document.createElement("span"); label.className="label"; label.textContent=f.nome;
        const sub=document.createElement("span"); sub.className="sub"; sub.textContent=`ID: ${f.id}`;
        left.appendChild(label); left.appendChild(sub);

        const right=document.createElement("div"); right.className="right";

        const editBtn=document.createElement("button");
        editBtn.className="mini-btn orange"; editBtn.textContent="Editar";
        editBtn.addEventListener("click",(e)=>{e.stopPropagation();editarFuncionario(idx);});

        const clearBtn=document.createElement("button");
        clearBtn.className="mini-btn"; clearBtn.textContent="Limpar"; clearBtn.title="Limpar registros";
        clearBtn.addEventListener("click",(e)=>{e.stopPropagation();limparRegistrosFuncionario(f.id,f.nome);});

        const upBtn=document.createElement("button");
        upBtn.className="mini-btn orange"; upBtn.textContent="Upar";
        upBtn.title="Upar para Gerente";
        upBtn.addEventListener("click",(e)=>{ e.stopPropagation(); uparParaGerente(f); });

        const delBtn=document.createElement("button");
        delBtn.className="mini-btn red"; delBtn.textContent="Remover";
        delBtn.addEventListener("click",(e)=>{e.stopPropagation();removerFuncionario(idx);});

        right.appendChild(editBtn);
        right.appendChild(clearBtn);
        right.appendChild(upBtn);
        right.appendChild(delBtn);

        chip.appendChild(left);
        chip.appendChild(right);
        listaFuncionariosEl.appendChild(chip);
      });
    }

    function renderTabela(){
      tabelaBodyEl.innerHTML="";
      const dados = Object.values(pessoas);
      if(dados.length===0){
        tabelaBodyEl.innerHTML=`<tr><td colspan="4" class="muted">Sem registros.</td></tr>`;
      } else {
        dados.forEach(p=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${p.nome}</td><td>${p.id}</td><td><span class="badge">${fmtHMS(p.total)}</span></td><td>${p.total}</td>`;
          tabelaBodyEl.appendChild(tr);
        });
      }
      renderRanking(dados);
      renderRegistrosSelecionado();
    }

    function renderRanking(dados){
      rankList.innerHTML="";
      const top = [...dados].sort((a,b)=>b.total-a.total).slice(0,3);
      if(top.length===0){
        rankList.innerHTML=`<div class="muted">Sem dados para o ranking.</div>`;
        return;
      }
      top.forEach((p,i)=>{
        const item=document.createElement("div");
        item.className="rank-item";
        item.innerHTML=`<span class="rank-pos">${i+1}¬∫</span><span>${p.nome}</span><span>${fmtHMS(p.total)}</span>`;
        rankList.appendChild(item);
      });
    }

    function renderRegistrosSelecionado(){
      registrosArea.innerHTML="";
      if(funcionarioSelecionado===null){
        registrosArea.innerHTML=`<div class="muted">Selecione um funcion√°rio para ver os registros.</div>`;
        return;
      }
      const f=funcionarios[funcionarioSelecionado];
      const chave=chavePessoa(f.nome,f.id);
      const pessoa=pessoas[chave];

      if(!pessoa || pessoa.registros.length===0){
        registrosArea.innerHTML=`<div class="muted">Sem registros para ${f.nome}.</div>`;
        return;
      }

      pessoa.registros.forEach(r=>{
        const item=document.createElement("div");
        item.className="reg-item";
        const time=document.createElement("span");
        time.className="time";
        time.textContent=`${r.h}h ${r.m}m ${r.s}s`;

        const remove=document.createElement("span");
        remove.className="remove";
        remove.textContent="Remover";
        remove.title="Remover registro";
        remove.dataset.id=r.id;
        remove.addEventListener("click", async ()=>{
          if(!confirm("Tem certeza que deseja remover este registro?")) return;
          await removerRegistro(r.id);
        });

        item.appendChild(time);
        item.appendChild(remove);
        registrosArea.appendChild(item);
      });
    }

    // ---------- Donos e Gerentes (TOP) ----------
    function renderResponsaveis(){
      listaResponsaveisEl.innerHTML="";
      if(!responsaveis || responsaveis.length===0){
        listaResponsaveisEl.innerHTML = "<p class='muted'>Nenhum respons√°vel cadastrado.</p>";
        return;
      }
      responsaveis.forEach(r=>{
        const chip=document.createElement("div");
        chip.className="chip";
        chip.title=`${r.nome} ‚Äî ID: ${r.id_ref ?? "-"}`;

        const left=document.createElement("div"); left.className="left";
        const label=document.createElement("span"); label.className="label"; label.textContent=r.nome;
        const sub=document.createElement("span"); sub.className="sub"; sub.textContent=`ID: ${r.id_ref ?? "-"}`;
        left.appendChild(label); left.appendChild(sub);

        const right=document.createElement("div"); right.className="right";
        const cargo=document.createElement("span"); cargo.className=`badge ${r.cargo}`; cargo.textContent=r.cargo;

        const remove=document.createElement("button");
        remove.className="mini-btn red"; remove.textContent="Remover";
        remove.addEventListener("click", async ()=>{
          await removerResponsavel(r.id);
        });

        right.appendChild(cargo);
        right.appendChild(remove);
        chip.appendChild(left);
        chip.appendChild(right);
        listaResponsaveisEl.appendChild(chip);
      });
    }

    async function carregarResponsaveis(){
      const { data, error } = await db.from("responsaveis").select("*").order("id",{ascending:true});
      if(error){ console.error(error); showError("Erro ao carregar respons√°veis."); responsaveis=[]; }
      else { responsaveis = data || []; }
      renderResponsaveis();
    }

    async function adicionarResponsavel(){
      const nome=(novoResponsavelNomeEl.value||"").trim();
      const idref=(novoResponsavelIdEl.value||"").trim();
      const cargo=(novoResponsavelCargoEl.value||"").trim();
      if(!nome || !cargo){ alert("Informe nome e cargo!"); return; }

      const payload = { nome, cargo, id_ref: idref || null };
      const { error } = await db.from("responsaveis").insert([payload]);
      if(error){ alert("Erro ao salvar respons√°vel: " + error.message); return; }

      novoResponsavelNomeEl.value="";
      novoResponsavelIdEl.value="";
      novoResponsavelCargoEl.value="Dono";
      await carregarResponsaveis();
    }

    async function removerResponsavel(id){
      const { error } = await db.from("responsaveis").delete().eq("id", id);
      if(error){ alert("Erro ao remover respons√°vel: " + error.message); return; }
      await carregarResponsaveis();
    }

    async function uparParaGerente(funcionario){
      const { data: existe, error: errCheck } = await db
        .from("responsaveis").select("id")
        .eq("id_ref", funcionario.id)
        .eq("cargo", "Gerente")
        .limit(1);
      if(errCheck){ showError("Falha ao verificar respons√°veis."); return; }
      if(existe && existe.length>0){ alert("Este funcion√°rio j√° est√° como Gerente."); return; }

      const { error } = await db.from("responsaveis").insert([
        { nome: funcionario.nome, id_ref: funcionario.id, cargo: "Gerente" }
      ]);
      if(error){ alert("Erro ao upar para Gerente: " + error.message); return; }
      await carregarResponsaveis();
    }

    // ---------- Registros ----------
    async function carregarFuncionarios(){
      const { data, error } = await db.from("funcionarios").select("*").order("nome",{ascending:true});
      if(error){ console.error(error); showError("Erro ao carregar funcion√°rios."); return; }
      funcionarios = data || [];
      renderFuncionarios();
    }

    async function carregarRegistros(){
      const { data, error } = await db.from("registros").select("*").order("id",{ascending:true});
      if(error){ console.error(error); showError("Erro ao carregar registros."); return; }
      const mapFunc = new Map(funcionarios.map(f=>[f.id,f.nome]));
      pessoas = {};
      (data||[]).forEach(r=>{
        const nome = mapFunc.get(r.funcionario_id) || "(Desconhecido)";
        const id = r.funcionario_id;
        const chave = chavePessoa(nome,id);
        if(!pessoas[chave]) pessoas[chave] = { nome, id, total: 0, registros: [] };
        pessoas[chave].total += r.total;
        pessoas[chave].registros.push({ id:r.id, h:r.horas, m:r.minutos, s:r.segundos, total:r.total });
      });
      renderTabela();
    }

    function selecionarFuncionario(idx){
      funcionarioSelecionado=idx;
      renderFuncionarios();
      renderRegistrosSelecionado();
    }

    async function adicionarFuncionario(){
      const nome=(novoNomeEl.value||"").trim();
      const id=(novoIdEl.value||"").trim();
      if(!nome || !id){ alert("Informe nome e ID!"); return; }

      const { data: existe, error: errCheck } = await db.from("funcionarios").select("id").eq("id",id).limit(1);
      if(errCheck){ showError("Falha ao verificar duplicidade."); return; }
      if(existe && existe.length>0){ alert("J√° existe um funcion√°rio com este ID."); return; }

      const { error } = await db.from("funcionarios").insert([{ id, nome }]);
      if(error){ alert("Erro ao salvar: " + error.message); return; }

      novoNomeEl.value=""; novoIdEl.value="";
      await carregarFuncionarios();
      await carregarRegistros();
    }

    async function editarFuncionario(idx){
      const atual = funcionarios[idx];
      const novoNome = prompt("Novo nome:", atual.nome);
      if(novoNome===null) return;
      const novoId = prompt("Novo ID:", atual.id);
      if(novoId===null) return;

      const nNome=(novoNome||"").trim();
      const nId=(novoId||"").trim();
      if(!nNome || !nId){ alert("Nome e ID n√£o podem ficar vazios."); return; }

      if(nId !== atual.id){
        const { data: existe, error: errCheck } = await db.from("funcionarios").select("id").eq("id",nId).limit(1);
        if(errCheck){ showError("Falha ao verificar duplicidade."); return; }
        if(existe && existe.length>0){ alert("J√° existe outro funcion√°rio com este ID."); return; }
      }

      const { error: errFunc } = await db.from("funcionarios").update({ nome: nNome, id: nId }).eq("id", atual.id);
      if(errFunc){ alert("Erro ao atualizar funcion√°rio: " + errFunc.message); return; }

      if(nId !== atual.id){
        const { error: errRegs } = await db.from("registros").update({ funcionario_id: nId }).eq("funcionario_id", atual.id);
        if(errRegs){ alert("Erro ao migrar registros: " + errRegs.message); return; }
      }

      await carregarFuncionarios();
      await carregarRegistros();
    }

    async function removerFuncionario(idx){
      const f = funcionarios[idx];
      if(!confirm(`Remover ${f.nome} (ID: ${f.id})? Isto apagar√° seus registros.`)) return;

      const { error } = await db.from("funcionarios").delete().eq("id", f.id);
      if(error){ alert("Erro ao remover funcion√°rio: " + err.message); return; }

      if(funcionarioSelecionado===idx) funcionarioSelecionado=null;
      else if(typeof funcionarioSelecionado==="number" && funcionarioSelecionado>idx) funcionarioSelecionado-=1;

      await carregarFuncionarios();
      await carregarRegistros();
    }

    async function adicionarRegistro(){
      if(funcionarioSelecionado===null){ showError("Selecione um funcion√°rio primeiro!"); return; }
      const h=parseInt(horasEl.value||"0",10);
      const m=parseInt(minutosEl.value||"0",10);
      const s=parseInt(segundosEl.value||"0",10);

      if(h===0 && m===0 && s===0){ showError("N√£o √© permitido adicionar um registro em branco."); return; }
      if([h,m,s].some(v=>Number.isNaN(v)||v<0)){ showError("Valores inv√°lidos (>= 0)."); return; }
      if(m>59 || s>59){ showError("Minutos/segundos devem estar entre 0 e 59."); return; }

      const f = funcionarios[funcionarioSelecionado];
      const total = toSeconds(h,m,s);

      const { error } = await db.from("registros").insert([{ funcionario_id: f.id, horas: h, minutos: m, segundos: s, total }]);
      if(error){ showError("Erro ao salvar registro: " + error.message); return; }

      horasEl.value=""; minutosEl.value=""; segundosEl.value="";
      await carregarRegistros();
    }

    async function removerRegistro(idRegistro){
      const { error } = await db.from("registros").delete().eq("id", idRegistro);
      if(error){ alert("Erro ao remover registro: " + error.message); return; }
      await carregarRegistros();
    }

    async function limparRegistrosFuncionario(funcionarioId, nome){
      if(!confirm(`Deseja limpar TODOS os registros de ${nome} (ID: ${funcionarioId})? Esta a√ß√£o n√£o pode ser desfeita.`)) return;
      const { error } = await db.from("registros").delete().eq("funcionario_id", funcionarioId);
      if(error){ alert("Erro ao limpar registros: " + error.message); return; }
      await carregarRegistros();
    }

    async function limparRegistrosTodos(){
      if(!confirm("Deseja limpar TODOS os registros de TODOS os funcion√°rios? Esta a√ß√£o n√£o pode ser desfeita.")) return;
      const { error } = await db.from("registros").delete().neq("id", 0);
      if(error){ alert("Erro ao limpar todos os registros: " + error.message); return; }
      await carregarRegistros();
    }

    function ordenarTabela(){
      const lista = Object.values(pessoas).sort((a,b)=>b.total - a.total);
      tabelaBodyEl.innerHTML="";
      if(lista.length===0){
        tabelaBodyEl.innerHTML=`<tr><td colspan="4" class="muted">Sem registros.</td></tr>`;
      } else {
        lista.forEach(p=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${p.nome}</td><td>${p.id}</td><td><span class="badge">${fmtHMS(p.total)}</span></td><td>${p.total}</td>`;
          tabelaBodyEl.appendChild(tr);
        });
      }
      renderRanking(lista);
    }

    // Eventos
    document.getElementById("btnAddFuncionario").addEventListener("click", adicionarFuncionario);
    document.getElementById("btnAddRegistro").addEventListener("click", adicionarRegistro);
    document.getElementById("btnOrdenar").addEventListener("click", ordenarTabela);
    document.getElementById("btnLimparTodos").addEventListener("click", limparRegistrosTodos);
    document.getElementById("btnAddResponsavel").addEventListener("click", adicionarResponsavel);

    // Init
    document.addEventListener("DOMContentLoaded", async ()=>{
      await carregarFuncionarios();
      await carregarRegistros();
      await carregarResponsaveis();
    });
  </script>
</body>
</html>
